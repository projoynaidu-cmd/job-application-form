<script>
  const token = localStorage.getItem('admin_token');
  if (!token) {
    window.location.href = 'login.html';
  }

  let applications = [];

  // ✅ Render Applications
  function renderApplications(apps) {
    const container = document.getElementById("appList");
    if (!Array.isArray(apps) || apps.length === 0) {
      container.innerHTML = "<p>No applications found.</p>";
      return;
    }

    container.innerHTML = apps.map((app) => `
      <div class="border p-4 rounded bg-gray-50 shadow-sm">
        <p><strong>🧑 Name:</strong> ${app.fullName}</p>
        <p><strong>📧 Email:</strong> ${app.email}</p>
        <p><strong>📞 Phone:</strong> ${app.phone}</p>
        <p><strong>💼 Position:</strong> ${app.position}</p>
        <p><strong>📅 Applied On:</strong> ${new Date(app.submittedAt).toLocaleString()}</p>
        <p><strong>🔗 LinkedIn:</strong> <a class="text-blue-600 underline" href="${app.linkedin}" target="_blank">Profile</a></p>
        <p><strong>📄 Resume:</strong> <a class="text-green-600 underline" href="https://job-application-form-p5bq.onrender.com/${app.resumePath.replace('\\', '/')}" target="_blank">View PDF</a></p>
        <button onclick="deleteApp('${app._id}')" class="mt-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
          🗑️ Delete
        </button>
      </div>
    `).join("");
  }

  // ✅ Fetch Applications
  fetch("https://job-application-form-p5bq.onrender.com/api/dashboard", {
    headers: {
      Authorization: "Bearer " + token
    }
  })
  .then((res) => res.json())
  .then((data) => {
    if (!Array.isArray(data)) {
      throw new Error(data.error || 'Invalid token');
    }
    applications = data;
    renderApplications(applications);
  })
  .catch((err) => {
    document.getElementById("appList").innerHTML =
      '<p class="text-red-600">Failed to load applications.</p>';
    console.error(err);
  });

  // 🔍 Live Search
  document.getElementById("search").addEventListener("input", (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = applications.filter(
      (app) =>
        app.fullName.toLowerCase().includes(term) ||
        app.email.toLowerCase().includes(term) ||
        app.position.toLowerCase().includes(term)
    );
    renderApplications(filtered);
  });

  // 🗑️ Delete Application
  function deleteApp(id) {
    if (confirm("Are you sure you want to delete this application?")) {
      fetch(`https://job-application-form-p5bq.onrender.com/api/dashboard/${id}`, {
        method: "DELETE",
        headers: {
          Authorization: "Bearer " + token
        }
      })
      .then((res) => res.json())
      .then(() => {
        applications = applications.filter((app) => app._id !== id);
        renderApplications(applications);
      })
      .catch((err) => {
        alert("Failed to delete. Try again.");
        console.error(err);
      });
    }
  }

  // 🔓 Logout
  function logout() {
    localStorage.removeItem("admin_token");
    window.location.href = "login.html";
  }
</script>
